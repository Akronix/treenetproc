---
title: "Introduction to treenetproc"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to treenetproc}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
# This is necessary to direct knitr to find the 
# 'data' directory, thanks to 
# https://stackoverflow.com/a/24585750/1036500
knitr::opts_knit$set(root.dir = normalizePath('../'))
```

```{r Figure 1, fig.width = 6, fig.height = 2, fig.retina = 2, echo = FALSE}
library(treenetproc)
data("dendro_data_L1")
data("dendro_data_L2")
example_L1 <- dendro_data_L1 %>% 
  dplyr::filter(series == "site-1_dendro-1")
example_L2 <- dendro_data_L2 %>% 
  dplyr::filter(series == "site-1_dendro-1")
layout(matrix(c(1, 2), nrow = 2), heights = c(1, 1),
       widths = 1)
par(mar = c(0, 2.1, 0, 1))
plot(data = example_L1, value ~ ts, type = "l", xaxt = "n", 
     yaxt = "n", ylab = "", las = 1, col = "grey70")
title(ylab = "raw", mgp = c(0.8, 1, 0))
par(mar = c(0, 2.1, 0, 1))
plot(data = example_L2, value ~ ts, type = "n", xaxt = "n", 
     yaxt = "n", ylab = "", xlab = "")
title(ylab = "processed", mgp = c(0.8, 1, 0))
lines(data = example_L2, value ~ ts, col = "#08519c")
```

```{r setup}
library(treenetproc)
```

The package `treenetproc` cleans dendrometer data by removing outliers and 
jumps in the data. The data is first aligned to regular time intervals (`L1`)
and then cleaned (`L2`).

## Format raw dendrometer and climate data
The raw dendrometer or climate data has to contain a timestamp column named
`ts`. The timestamp can be in any standard date format (default is 
`date_format = "%Y-%m-%d %H:%M:%S"`).

Raw dendrometer or climate data can either be provided in `input = long` 
format with  dendrometer names specified in a column named `series` 
(Table 1). Alternatively the data can be provided in `input = wide` format 
with data series in different columns (Table 2).

```{r head of dendro_data_L0, echo = FALSE, results = "asis"}
data("dendro_data_L0")
knitr::kable(dendro_data_L0[1:5, ], caption = "Table 1: Raw dendrometer data
             in 'long' format.")
```

```{r head of dendro_data_L0_wide, echo = FALSE, results = "asis"}
data("dendro_data_L0_wide")
knitr::kable(dendro_data_L0_wide[1:5, ], caption = "Table 2: Raw dendrometer and
             temperature data in 'wide' format.")
```


## Process data to L1 (time alignement)
After converting the data to the correct format it has to be time-aligned to
regular time intervals with the function `proc_L1`. The desired time 
resolution of the data can be specified with `reso` (in minutes). How the
time alignement works is documented in 
([Functionality of treenetproc](Functionality-of-treenetproc.html), this 
vignette is under development and not yet available).

```{r prepare data for proc_L1, echo = FALSE}
# reduce size of dendro_data_L0 to make computing of proc_L1 faster
data("dendro_data_L0")
dendro_data_L0 <- dendro_data_L0[1:100, ]
```

```{r examples of proc_L1, results = "hide"}
# Data in 'long' format
proc_L1(data = dendro_data_L0, reso = 10, input = "long")

# Data in 'wide' format
proc_L1(data = dendro_data_L0_wide, reso = 10, input = "wide")
```


## Process data to L2 (dendrometer data cleaning)
Time-aligned dendromter data can be cleaned with the function 
`proc_dendro_L2`. The function returns a `data.frame` containing the 
cleaned dendrometer data (Table 3).

```{r prepare for proc_dendro_L2, echo = FALSE}
# reduce size of dendro_data_L1 to make computing of proc_dendro_L2 faster
data("dendro_data_L1")
dendro_data_L1 <- dendro_data_L1 %>% 
  dplyr::filter(series == "site-1_dendro-1")
```

```{r process to L2, results = "hide", message = FALSE, warning = FALSE}
# Clean time-aligned (L1) dendrometer data
proc_dendro_L2(dendro_data = dendro_data_L1, plot = FALSE)
```

```{r Table 3, echo = FALSE}
data("dendro_data_L2")
knitr::kable(dendro_data_L2[1:5, ], caption = "Table 3: Processed dendrometer
             data.")
```

The output `data.frame` contains the following columns:

* **series**: name of the series
* **ts**: timestamp with format `%Y-%m-%d %H:%M:%S`
* **value**: dendrometer value
* **max**: highest measured dendrometer `value` up to this timestamp
* **twd**: tree water deficit, i.e. the amount of stem shrinkage
  expressed as the difference between `max` and `value`
* **mds**: maximum daily shrinkage (see `?proc_dendro_L2` for more
  information)
* **gro_yr**: growth since the beginning of the year
* **gro_start**: day of year at which growth starts. `gro_start` is defined
  as the day of year at which 5% of total yearly growth is surpassed
* **gro_end**: day of year at which growth stops. `gro_end` is defined as 
  the day of year at which 95% of total yearly growth is reached
* **frost**: indicates periods of probable frost (i.e. periods where the 
  temperature < `lowtemp`)
* **flags**: character vector specifying the changes that occurred during the
  processing, see below for details
* **version**: processing version
* **version_pck**: package version number

The column `flags` contains all changes that occurred during the processing. 
The numbers after the name of the flag specify in which iteration of the 
cleaning process the changes occurred:

* **out**: removed outlier point
* **jump**: corrected a jump
* **fill**: value is linearly interpolation between the two closest available 
  measured values (length of gaps that are linearly interpolated can be 
  specified in `interpol`)

By default all changes are plotted (`plot = TRUE`) and saved to a PDF file
in the current working directory (`plot_export = TRUE`). 
The plot contains...

* the original `L1` data in the first panel, 
* the processed `L2` data (with `L1` in the background) in the second 
  panel (interpolated points are circled), 
* the changes between `L1` and `L2` (red) as well as the deleted values
  (pink) in the third panel, 
* the tree water deficit (twd) in the last panel,
* and the input variables as well as the applied threshold values at the 
  bottom.

```{r processs to L2, fig.show="hide", fig.height=7, fig.width=6, message=FALSE, warning=FALSE, results="hide"}
# Clean time-aligned (L1) dendrometer data and plot changes
proc_dendro_L2(dendro_data = dendro_data_L1, plot_period = "monthly",
               plot_export = FALSE)
```

```{r plot L2 data, echo = FALSE, fig.height = 7, fig.retina = 2, fig.width = 6}
# prepare dendro_data_L2 for plotting (subset to single dendrometer)
dendro_data_L2 <- dendro_data_L2 %>% 
  dplyr::filter(series == "site-1_dendro-1")

proc_dendro_L2(dendro_data = dendro_data_L1, plot_period = "monthly", 
               plot_export = FALSE)
```

When plotted monthly (`plot_period = "monthly"`), the changes that occurred 
during the processing are numbered. Alternatively the plots can be drawn for 
the full period of data (`plot_period = "full"`) or for each year 
separately (`plot_period = "yearly"`). In these cases, the changes are not 
numbered.


### Rigidity of data cleaning
The rigidity of the data cleaning can be adjusted with the variables
`tol_out` and `tol_jump`. An increase in the variables leads to an increase
in the thresholds used to classify outliers or jumps.

An increase of the variable `tol_out` makes sense if values are deleted 
(i.e. classified as outliers) that are not outliers. A  decrease, in contrast,
is sensible if outliers are not detected as such.
Similarly, an increase of the variable `tol_jump` makes sense if a dendrometer
series is flattened during processing (see example below). A decrease, in
contrast, makes sense if obvious jumps are not corrected.

The applied threshold values are printed at the bottom of the plots as:

`tol_jump: -436.14 / 437.15`

`tol_out: -92.24 / 93.26`


#### Data cleaning with low 'tol_jump' and 'tol_out'
```{r shrinking example code, results="hide", fig.show="hide", fig.height=7, fig.width=6, message = FALSE, warning = FALSE}
# load data
data("dendro_data_L1")
# subset data for example
data_L1 <- dendro_data_L1 %>% 
  dplyr::filter(series == "site-1_dendro-2")

# clean dendrometer data (tol_jump = 1, tol_out = 1)
proc_dendro_L2(dendro_data = data_L1, tol_jump = 1, tol_out = 1, 
               plot_export = FALSE)
```

```{r shrinking example plot, echo=FALSE, fig.width=5, fig.height=3, fig.retina = 2}
data("dendro_data_L1")
data_L1 <- dendro_data_L1 %>% 
  dplyr::filter(series == "site-1_dendro-2")

data_shrink_L2 <- proc_dendro_L2(dendro_data = data_L1, tol_jump = 1,
                                 tol_out = 1, plot = FALSE)

par(mar = c(2.1, 4, 1, 2))
plot(data = data_shrink_L2, value ~ ts, type = "n", ylab = "L2", 
     las = 1)
lines(data = data_L1, value ~ ts, col = "grey70")
lines(data = data_shrink_L2, value ~ ts, col = "#08519c")
```


#### Data cleaning with increased value of 'tol_jump' and 'tol_out'
```{r shrinking example higher tol code, fig.show="hide", fig.height=7, fig.width=6, results="hide", message = FALSE, warning = FALSE}
# clean dendrometer data (default value of tol_jump and tol_out)
proc_dendro_L2(dendro_data = data_L1, tol_jump = 50, tol_out = 10, 
               plot_export = FALSE)
```

```{r shrinking example higher tol code #2, echo=FALSE, results = "hide", fig.show="hide", fig.height=7, fig.width=6, message = FALSE, warning = FALSE}
data_L2 <- proc_dendro_L2(dendro_data = data_L1, tol_jump = 50, 
                          tol_out = 10, plot_export = FALSE)
```

```{r shrinking example higher tol plot, echo=FALSE, fig.width=5, fig.height=3, fig.retina=2}
par(mar = c(2.1, 4, 1, 2))
plot(data = data_L2, value ~ ts, type = "n", ylab = "L2", 
     las = 1)
lines(data = data_L1, value ~ ts, col = "grey70")
lines(data = data_L2, value ~ ts, col = "#08519c")
```

### Temperature data
Including temperature data measured on site ensures that frost events are 
not treated as outliers during data cleaning. Frost is assumed as soon as
temperatures drop below the value specified in `lowtemp`. Temperature data 
can either be provided along with the dendrometer data (series name has to 
contain `temp`), or it can be provided separately to `temp_data`.

In periods of probable frost (if temperature < `lowtemp`) the threshold for 
outlier detection is multiplied by `frost_thr`. Periods of probable frost are
indicated with a horizontal line in the plot (see below).

If no tempearture data is provided, a sample temperature dataset is used.
The sample temperature dataset assumes frost in the months December,
January and February; i.e. the temperature is set to 0°C. In all other 
months the temperature is set to 10°C.


#### Data cleaning without temperature data
```{r frost no temp data_1, fig.show="hide", fig.height=7, fig.width=6, message=FALSE, warning=FALSE, results="hide"}
# load data
data("dendro_data_L1")
# subset data for example
data_L1 <- dendro_data_L1 %>% 
  dplyr::filter(series == "site-1_dendro-4")

# clean dendrometer data (without temperature data)
proc_dendro_L2(dendro_data = data_L1, plot_export = FALSE)
```

```{r frost no temp data_2, echo=FALSE, results="hide", fig.width=5, fig.height=3, fig.retina = 2, warning=FALSE, message=FALSE}
# load data
data("dendro_data_L2")
# subset data for example
data_L2 <- dendro_data_L2 %>% 
  dplyr::filter(series == "site-1_dendro-4")

par(mar = c(2.1, 4, 1, 2))
plot(data = data_L2, value ~ ts, type = "n", ylab = "L2", 
     las = 1)
lines(data = data_L1, value ~ ts, col = "grey70")
lines(data = data_L2, value ~ ts, col = "#08519c")
```


#### Data cleaning with temperature data
```{r frost with temp data_1, fig.show="hide", fig.height=7, fig.width=6, message=FALSE, warning=FALSE, results="hide"}
# load temperature data
data("temp_data_L0")
# time-align temperature data
temp_L1 <- proc_L1(data = temp_data_L0)

# clean dendrometer data (with temperature data)
proc_dendro_L2(dendro_data = data_L1, temp_data = temp_L1, 
               plot_export = FALSE)
```

```{r frost with temp data_2, echo=FALSE, results="hide", fig.width=5, fig.height=3, fig.retina = 2, warning=FALSE, message=FALSE}
# load data
data("temp_data_L1")
data_L2 <- proc_dendro_L2(dendro_data = data_L1, temp_data = temp_data_L1, 
                          plot = FALSE)

par(mar = c(2.1, 4, 1, 2))
plot(data = data_L2, value ~ ts, type = "n", ylab = "L2", 
     las = 1)
lines(data = data_L1, value ~ ts, col = "grey70")
lines(data = data_L2, value ~ ts, col = "#08519c")
# add abline to indicate frost (not based on real temperature data)
plot_frost_period(data_L2 = data_L2)
```


## Process data to L3 (correct mistakes in data cleaning)
If not all errors in data cleaning can be removed by changing the default 
values of `tol_jump` and/or `tol_out`, they can be removed using the function
`corr_dendro_L3`. There are three possibilities to revert wrong changes:

* **remove**: specify the numbers of the changes that should be reverted.
  Remaining changes are renumbered starting at 1.
* **force**: force a jump in the data that was not corrected for by 
  specifying a point in time prior (but close to) where the jump should occur.
* **delete**: delete an entire region of erroneous data by specifying a
  date range. This can also be done for `L1` data with the function 
  `corr_dendro_L1`.


#### Data cleaning to L2
```{r corr_dendro_L3 example_1, results="hide", fig.width=6, fig.height=7, fig.retina=2, message=FALSE, warning=FALSE}
# load data
data("dendro_data_L1")
# subset data for example
data_L1 <- dendro_data_L1 %>% 
  dplyr::filter(series == "site-1_dendro-3")

# clean dendrometer data
proc_dendro_L2(dendro_data = data_L1, plot_period = "monthly", 
               plot_export = FALSE)
```


#### Correct errors in data cleaning
```{r corr_dendro_L3 example_2, echo=FALSE, results="hide"}
# load data
data("dendro_data_L2")
```

```{r corr_dendro_L3 example_3, results="hide", fig.width=6, fig.height=7, fig.retina=2, message=FALSE, warning=FALSE}
# correct errors in dendrometer data cleaning
corr_dendro_L3(data_L1 = data_L1, data_L2 = dendro_data_L2, 
               remove = c(1:4, 6), force = "2016-08-12", 
               delete = c("2016-08-01", "2016-08-05"),
               series = "site-1_dendro-3", plot_export = FALSE)
```

